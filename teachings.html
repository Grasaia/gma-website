<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Teachings - Grandma's Ministry</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="site-header">
    <div class="container">
      <div class="site-title">
        <img src="img/gma-pfp.jpg" alt="Grandma logo">
        <h1>Grandma's Ministry</h1>
      </div>
      <button id="hamburgerBtn" class="hamburger" aria-label="Toggle menu">☰</button>
      <nav class="primary">
        <a href="index.html">Home</a>
        <a href="teachings.html">Teachings</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
        <a href="donations.html" class="cta">Donate</a>
      </nav>
    </div>
  </header>

  <header>
    <h1 class="container">Teachings</h1>
  </header>

  <section class="container">
    <p>Watch all teachings and messages on our YouTube channel. Click a card to load the video (lazy-loaded to keep the page fast).</p>
    <div id="videoCatalog" class="video-catalog"></div>
  </section>

  <footer>
    <div class="widgets">
      <a href="events.html">Events</a>
      <a href="portfolio.html">Portfolio</a>
      <a href="donations.html">Donations</a>
      <a href="blog.html">Blog</a>
      <a href="bookings.html">Bookings</a>
    </div>
  </footer>

  <!-- Firebase (compat) scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="scripts.js"></script>
  <script>
  // Default videos (used if none in storage/Firestore)
  const defaultVideos = [
    {id:'vid-1',youtubeId:'VIDEO_ID',title:'Teaching Title',date:'2026-01-05',desc:'Lorem ipsum dolor sit amet.'}
  ];
  let videos = [];

  // small helper to extract YouTube ID from a URL or ID
  function extractYouTubeId(input){
    if(!input) return '';
    const idMatch = input.match(/[?&]v=([^&]+)/);
    if(idMatch) return idMatch[1];
    const shortMatch = input.match(/youtu\.be\/([^?]+)/);
    if(shortMatch) return shortMatch[1];
    // assume raw id
    return input;
  }

  async function renderVideos(){
    const catalog = document.getElementById('videoCatalog');
    catalog.innerHTML='';
    videos.forEach(v=>{
      const card = document.createElement('div'); card.className='video-card'; card.setAttribute('data-id', v.id);
      card.innerHTML = `
        <div class="embed-wrap" data-yt="${v.youtubeId}">
          <img class="thumb-img" src="https://img.youtube.com/vi/${v.youtubeId}/hqdefault.jpg" alt="${v.title}">
          <div style="position:absolute;left:8px;right:8px;top:8px;bottom:8px;display:flex;align-items:center;justify-content:center;pointer-events:none"><div style="width:64px;height:64px;background:rgba(0,0,0,0.6);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:28px">▶</div></div>
        </div>
        <div class="video-body">
          <h4>${v.title} ${videos.indexOf(v)===0?'<span style="background:var(--color-accent);color:#111;padding:4px 8px;border-radius:6px;font-size:12px;margin-left:8px">Newest</span>':''}</h4>
          <small>${v.date?('Posted: '+v.date):''}</small>
          <p>${v.desc || ''}</p>
          <a class="watch-link" href="https://youtube.com/watch?v=${v.youtubeId}" target="_blank">Watch on YouTube</a>
        </div>
        <div class="comments" id="comments-${v.id}">
          <h4>Comments</h4>
          <input placeholder="Your name" class="comment-name" aria-label="Your name">
          <textarea placeholder="Your message" class="comment-msg" aria-label="Your message"></textarea>
          <button class="comment-submit">Submit</button>
          <div class="comments-list"></div>
        </div>
      `;
      catalog.appendChild(card);
    });

    // attach play handlers -> open detail dialog
    catalog.querySelectorAll('.embed-wrap').forEach(el=>{
      el.addEventListener('click', function(){
        const parent = this.closest('.video-card');
        const vid = parent && parent.getAttribute('data-id');
        const video = videos.find(v=>v.id === vid);
        if(video) openVideoDetail(video);
      });
    });

    // detail dialog exists to show video, description, and comments
    if(!document.getElementById('videoDialog')){
      const d = document.createElement('dialog'); d.id='videoDialog'; d.className='modal hidden'; d.setAttribute('aria-hidden','true');
      d.innerHTML = `<div class="modal-content"><button id="videoDialogClose" class="modal-close" aria-label="Close">✕</button><div id="videoDialogInner"></div></div>`;
      document.body.appendChild(d);
      document.getElementById('videoDialogClose').addEventListener('click', ()=>{ closeVideoDetail(); });
    }

    // attach comment handlers (use closest comments container to find video id)
    catalog.querySelectorAll('.comment-submit').forEach(btn=>{
      btn.addEventListener('click', async function(){
        const wrapper = this.closest('.comments');
        const name = wrapper.querySelector('.comment-name').value.trim() || 'Anonymous';
        const message = wrapper.querySelector('.comment-msg').value.trim();
        if(!message) return alert('Please write a message');
        const vid = wrapper.id.replace('comments-','');
        try{
          // button pressed visual
          this.classList.add('pressed');
          this.disabled = true; this.innerText='Posting...';
          await saveComment({videoId:vid,name,message,createdAt:new Date()});
          wrapper.querySelector('.comment-msg').value='';
          await loadCommentsFor(vid);
        }catch(e){ alert('Error saving comment. Check Firebase setup.'); }
        finally{ this.disabled=false; this.classList.remove('pressed'); this.innerText='Submit'; }
      });
    });

    // load comments for each video
    videos.forEach(v=>loadCommentsFor(v.id));
  }

  async function loadCommentsFor(videoId){
    try{
      const list = document.querySelector(`#comments-${videoId} .comments-list`);
      if(!list) return;
      list.innerHTML='Loading...';
      const comments = await getCommentsForVideo(videoId);
      if(!comments.length){ list.innerHTML='<p>No comments yet.</p>'; return; }
      list.innerHTML = '';
      comments.forEach(c=>{
        const div = document.createElement('div');
        div.className='comment';
        div.innerHTML = `<div class="meta">${c.name} • ${fmtDate(c.createdAt)}</div><div class="text">${c.message}</div>`;
        list.appendChild(div);
      });
    }catch(e){ console.warn('Comments load error',e); }
  }

  // Add video admin form (grandma can add new videos)
  async function initAddVideoForm(){
    const adminToggle = document.createElement('div'); adminToggle.style.marginBottom='12px';
    adminToggle.innerHTML = `<button id="adminToggle" class="btn secondary">Admin</button> <span style="margin-left:10px;color:#666;font-size:13px">(Click to reveal the Add Video form)</span>`;
    const section = document.querySelector('.container');
    section.insertBefore(adminToggle, section.querySelector('#videoCatalog'));

    const wrapper = document.createElement('div'); wrapper.id='addVideoAdmin'; wrapper.style.display='none';
    const container = document.createElement('div'); container.className='card'; container.style.marginBottom='16px';
    container.innerHTML = `
      <h3>Add New Video (admin)</h3>
      <form id="addVideoForm">
        <label for="yt-input">YouTube URL or ID</label>
        <input id="yt-input" required>
        <label for="vid-title">Title</label>
        <input id="vid-title" required>
        <label for="vid-date">Date</label>
        <input id="vid-date" type="date" value="${new Date().toISOString().slice(0,10)}">
        <label for="vid-desc">Description</label>
        <textarea id="vid-desc" rows="3"></textarea>
        <button class="btn" type="submit">Add Video</button>
      </form>
      <p style="font-size:13px;color:#666;margin-top:8px">Tip: paste a full YouTube URL or the video id.</p>
    `;
    wrapper.appendChild(container);
    section.insertBefore(wrapper, section.querySelector('#videoCatalog'));

    // admin toggle: shows login dialog or logs out if already signed in
    document.getElementById('adminToggle').addEventListener('click', function(){
      if(isAdmin()){
        // logout
        setAdmin(false);
        wrapper.style.display='none';
        this.innerText = 'Admin';
        alert('Logged out');
        return;
      }
      showAdminDialog();
    });

    // ensure initial admin state respected
    if(isAdmin()){
      wrapper.style.display='block';
      document.getElementById('adminToggle').innerText = 'Admin (signed in) - Logout';
    }

    document.getElementById('addVideoForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const raw = document.getElementById('yt-input').value.trim();
      const youtubeId = extractYouTubeId(raw);
      const title = document.getElementById('vid-title').value.trim();
      const date = document.getElementById('vid-date').value;
      const desc = document.getElementById('vid-desc').value.trim();
      if(!youtubeId || !title) return alert('YouTube ID and Title are required');
      try{
        const saved = await saveVideo({youtubeId,title,date,desc,createdAt:new Date()});
        const newId = saved.id || saved.name || ('vid-'+Date.now());
        const newV = {id:newId,youtubeId,title,date,desc};
        videos.unshift(newV);
        renderVideos();
        this.reset();
        alert('Video added');
      }catch(e){ console.error(e); alert('Error adding video. Check Firebase setup.'); }
    });
  }

  // Init rendering when ready
  document.addEventListener('DOMContentLoaded', async function(){
    // Create CTA
    const cta = document.createElement('p'); cta.innerHTML = "<strong>This is where all of my videos can be found. I am always uploading new content.</strong> <a href='#videoCatalog' class='btn'>Access Catalog</a>";
    const section = document.querySelector('.container'); section.insertBefore(cta, section.firstChild);

    // Load videos from storage or fallback
    try{
      const stored = await getAllVideos();
      if(stored && stored.length) videos = stored.map(v=>({id:v.id || ('vid-'+Date.now()), youtubeId:v.youtubeId, title:v.title, date:v.date, desc:v.desc}));
      else videos = defaultVideos.slice();
    }catch(e){ videos = defaultVideos.slice(); }

    await initAddVideoForm();
    renderVideos();
  });
  </script>
</body>
</html>
